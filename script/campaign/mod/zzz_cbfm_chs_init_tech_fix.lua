cbfm_chs_init_tech_faction_info_table = {
	["wh3_dlc20_chs_valkia"] = {
		["techs"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"wh3_dlc20_chs_kho_valkia_military_1","wh3_dlc20_chs_kho_shared_gift_upgrade_authority","wh3_dlc20_chs_kho_shared_gift_upgrade_corruption","wh3_dlc20_chs_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"wh3_dlc20_chs_und_shared_corruption","wh3_dlc20_chs_und_shared_diplomacy"}
		},
		["effect_bundles"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"CBFM_upgrade_all_kho_weapon_strength","CBFM_upgrade_all_kho_authority","CBFM_upgrade_all_kho_corruption","CBFM_upgrade_all_kho_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"CBFM_upgrade_all_und_corruption","CBFM_upgrade_all_und_diplomacy"}
		},
		["base_values"] = 
		{
			["wh_main_effect_force_stat_weapon_strength"] = 5,
			["wh3_main_faction_political_diplomacy_mod_technology_khorne"] = 15,
			["wh_dlc03_faction_political_diplomacy_mod_technology_beastmen"] = 15,
			["wh_main_faction_political_diplomacy_mod_technology_norsca"] = 15,
			["wh2_main_faction_political_diplomacy_mod_technology_skaven"] = 15,
			["wh3_main_effect_corruption_chaos_technology"] = 2
		}
	},
	["wh3_dlc20_chs_azazel"] = 
	{
		["techs"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"wh3_dlc20_chs_sla_azazel_military_1","wh3_dlc20_chs_sla_shared_gift_upgrade_authority","wh3_dlc20_chs_sla_shared_gift_upgrade_corruption","wh3_dlc20_chs_sla_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"wh3_dlc20_chs_und_shared_corruption","wh3_dlc20_chs_und_shared_diplomacy"}
		},
		["effect_bundles"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"CBFM_upgrade_all_sla_speed","CBFM_upgrade_all_sla_authority","CBFM_upgrade_all_sla_corruption","CBFM_upgrade_all_sla_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"CBFM_upgrade_all_und_corruption","CBFM_upgrade_all_und_diplomacy"}
		},
		["base_values"] = 
		{
			["wh_main_effect_character_stat_speed"] = 5,
			["wh3_main_faction_political_diplomacy_mod_technology_slaanesh"] = 15,
			["wh_dlc03_faction_political_diplomacy_mod_technology_beastmen"] = 15,
			["wh_main_faction_political_diplomacy_mod_technology_norsca"] = 15,
			["wh2_main_faction_political_diplomacy_mod_technology_skaven"] = 15,
			["wh3_main_effect_corruption_chaos_technology"] = 2
		}
	},
	["wh3_dlc20_chs_vilitch"] = 
	{
		["techs"] =
		{
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"wh3_dlc20_chs_tze_vilitch_military_1","wh3_dlc20_chs_tze_shared_gift_upgrade_authority","wh3_dlc20_chs_tze_shared_gift_upgrade_corruption","wh3_dlc20_tze_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"wh3_dlc20_chs_und_shared_corruption","wh3_dlc20_chs_und_shared_diplomacy"}
		},
		["effect_bundles"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"CBFM_upgrade_all_tze_physical_resistance","CBFM_upgrade_all_tze_authority","CBFM_upgrade_all_tze_corruption","CBFM_upgrade_all_tze_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"CBFM_upgrade_all_und_corruption","CBFM_upgrade_all_und_diplomacy"}
		},
		["base_values"] = 
		{
			["wh_main_effect_force_stat_physical_resistance"] = 3,
			["wh3_main_faction_political_diplomacy_mod_tzeentch"] = 15,
			["wh_dlc03_faction_political_diplomacy_mod_technology_beastmen"] = 15,
			["wh_main_faction_political_diplomacy_mod_technology_norsca"] = 15,
			["wh2_main_faction_political_diplomacy_mod_technology_skaven"] = 15,
			["wh3_main_effect_corruption_chaos_technology"] = 2
		}
	},
	["wh3_dlc20_chs_festus"] = 
	{
		["techs"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"wh3_dlc20_chs_nur_festus_military_1","wh3_dlc20_chs_nur_shared_gift_upgrade_authority","wh3_dlc20_chs_nur_shared_gift_upgrade_corruption","wh3_dlc20_chs_nur_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"wh3_dlc20_chs_und_shared_corruption","wh3_dlc20_chs_und_shared_diplomacy"}
		},
		["effect_bundles"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"CBFM_upgrade_all_nur_healing_cap","CBFM_upgrade_all_nur_authority","CBFM_upgrade_all_nur_corruption","CBFM_upgrade_all_nur_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"CBFM_upgrade_all_und_corruption","CBFM_upgrade_all_und_diplomacy"}
		},
		["base_values"] = 
		{
			["wh3_dlc20_effect_healing_cap_modifier"] = 0.1,
			["wh3_main_faction_political_diplomacy_mod_nurgle"] = 15,
			["wh_dlc03_faction_political_diplomacy_mod_technology_beastmen"] = 15,
			["wh_main_faction_political_diplomacy_mod_technology_norsca"] = 15,
			["wh2_main_faction_political_diplomacy_mod_technology_skaven"] = 15,
			["wh3_main_effect_corruption_chaos_technology"] = 2
		}
	},
	["wh_main_chs_chaos"] = 
	{
		["techs"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"wh3_dlc20_chs_und_shared_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"wh3_dlc20_chs_kho_shared_gift_upgrade_authority","wh3_dlc20_chs_kho_shared_gift_upgrade_corruption","wh3_dlc20_chs_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"wh3_dlc20_chs_sla_shared_gift_upgrade_authority","wh3_dlc20_chs_sla_shared_gift_upgrade_corruption","wh3_dlc20_chs_sla_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"wh3_dlc20_chs_tze_shared_gift_upgrade_authority","wh3_dlc20_chs_tze_shared_gift_upgrade_corruption","wh3_dlc20_tze_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"wh3_dlc20_chs_nur_shared_gift_upgrade_authority","wh3_dlc20_chs_nur_shared_gift_upgrade_corruption","wh3_dlc20_chs_nur_shared_gift_upgrade_diplomacy"}
		},		
		["effect_bundles"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"CBFM_upgrade_all_und_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"CBFM_upgrade_all_kho_authority","CBFM_upgrade_all_kho_corruption","CBFM_upgrade_all_kho_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"CBFM_upgrade_all_sla_authority","CBFM_upgrade_all_sla_corruption","CBFM_upgrade_all_sla_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"CBFM_upgrade_all_tze_authority","CBFM_upgrade_all_tze_corruption","CBFM_upgrade_all_tze_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"CBFM_upgrade_all_nur_authority","CBFM_upgrade_all_nur_corruption","CBFM_upgrade_all_nur_diplomacy"}
		},
		["base_values"] = 
		{
			["wh3_main_faction_political_diplomacy_mod_technology_khorne"] = 15,
			["wh3_main_faction_political_diplomacy_mod_technology_slaanesh"] = 15,
			["wh3_main_faction_political_diplomacy_mod_tzeentch"] = 15,
			["wh3_main_faction_political_diplomacy_mod_nurgle"] = 15,
			["wh_dlc03_faction_political_diplomacy_mod_technology_beastmen"] = 15,
			["wh_main_faction_political_diplomacy_mod_technology_norsca"] = 15,
			["wh2_main_faction_political_diplomacy_mod_technology_skaven"] = 15
		}
	},
	["wh3_dlc20_chs_sigvald"] = 
	{
		["techs"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"wh3_dlc20_chs_und_shared_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"wh3_dlc20_chs_kho_shared_gift_upgrade_authority","wh3_dlc20_chs_kho_shared_gift_upgrade_corruption","wh3_dlc20_chs_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"wh3_dlc20_chs_sla_shared_gift_upgrade_authority","wh3_dlc20_chs_sla_shared_gift_upgrade_corruption","wh3_dlc20_chs_sla_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"wh3_dlc20_chs_tze_shared_gift_upgrade_authority","wh3_dlc20_chs_tze_shared_gift_upgrade_corruption","wh3_dlc20_tze_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"wh3_dlc20_chs_nur_shared_gift_upgrade_authority","wh3_dlc20_chs_nur_shared_gift_upgrade_corruption","wh3_dlc20_chs_nur_shared_gift_upgrade_diplomacy"}
		},		
		["effect_bundles"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"CBFM_upgrade_all_und_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"CBFM_upgrade_all_kho_authority","CBFM_upgrade_all_kho_corruption","CBFM_upgrade_all_kho_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"CBFM_upgrade_all_sla_authority","CBFM_upgrade_all_sla_corruption","CBFM_upgrade_all_sla_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"CBFM_upgrade_all_tze_authority","CBFM_upgrade_all_tze_corruption","CBFM_upgrade_all_tze_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"CBFM_upgrade_all_nur_authority","CBFM_upgrade_all_nur_corruption","CBFM_upgrade_all_nur_diplomacy"}
		},
		["base_values"] = 
		{
			["wh3_main_faction_political_diplomacy_mod_technology_khorne"] = 15,
			["wh3_main_faction_political_diplomacy_mod_technology_slaanesh"] = 15,
			["wh3_main_faction_political_diplomacy_mod_tzeentch"] = 15,
			["wh3_main_faction_political_diplomacy_mod_nurgle"] = 15,
			["wh_dlc03_faction_political_diplomacy_mod_technology_beastmen"] = 15,
			["wh_main_faction_political_diplomacy_mod_technology_norsca"] = 15,
			["wh2_main_faction_political_diplomacy_mod_technology_skaven"] = 15
		}
	},
	["wh3_dlc20_chs_kholek"] = 
	{
		["techs"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"wh3_dlc20_chs_und_shared_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"wh3_dlc20_chs_kho_shared_gift_upgrade_authority","wh3_dlc20_chs_kho_shared_gift_upgrade_corruption","wh3_dlc20_chs_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"wh3_dlc20_chs_sla_shared_gift_upgrade_authority","wh3_dlc20_chs_sla_shared_gift_upgrade_corruption","wh3_dlc20_chs_sla_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"wh3_dlc20_chs_tze_shared_gift_upgrade_authority","wh3_dlc20_chs_tze_shared_gift_upgrade_corruption","wh3_dlc20_tze_kho_shared_gift_upgrade_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"wh3_dlc20_chs_nur_shared_gift_upgrade_authority","wh3_dlc20_chs_nur_shared_gift_upgrade_corruption","wh3_dlc20_chs_nur_shared_gift_upgrade_diplomacy"}
		},		
		["effect_bundles"] = 
		{
			["wh3_dlc20_faction_initiative_set_chs_undivided"] = {"CBFM_upgrade_all_und_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_khorne"] = {"CBFM_upgrade_all_kho_authority","CBFM_upgrade_all_kho_corruption","CBFM_upgrade_all_kho_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_slaanesh"] = {"CBFM_upgrade_all_sla_authority","CBFM_upgrade_all_sla_corruption","CBFM_upgrade_all_sla_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_tzeentch"] = {"CBFM_upgrade_all_tze_authority","CBFM_upgrade_all_tze_corruption","CBFM_upgrade_all_tze_diplomacy"},
			["wh3_dlc20_faction_initiative_set_chs_nurgle"] = {"CBFM_upgrade_all_nur_authority","CBFM_upgrade_all_nur_corruption","CBFM_upgrade_all_nur_diplomacy"}
		},
		["base_values"] = 
		{
			["wh3_main_faction_political_diplomacy_mod_technology_khorne"] = 15,
			["wh3_main_faction_political_diplomacy_mod_technology_slaanesh"] = 15,
			["wh3_main_faction_political_diplomacy_mod_tzeentch"] = 15,
			["wh3_main_faction_political_diplomacy_mod_nurgle"] = 15,
			["wh_dlc03_faction_political_diplomacy_mod_technology_beastmen"] = 15,
			["wh_main_faction_political_diplomacy_mod_technology_norsca"] = 15,
			["wh2_main_faction_political_diplomacy_mod_technology_skaven"] = 15
		}
	}
}

function cbfm_chs_init_tech_update(faction_key,called_from)

	ModLog("DUX: cbfm_chs_init_tech_update function called from " .. called_from .. " with faction parameter " .. tostring(faction_key))
	
	local faction_entry = cbfm_chs_init_tech_faction_info_table[faction_key]
	local faction_obj = cm:get_faction(faction_key)
	
	-- if an invalid faction was passed, or faction doesn't exist (e.g., realms campaign), or faction is dead: we can stop right here
	if not faction_entry or not faction_obj or faction_obj:is_dead() then
		ModLog("DUX: invalid parameter or non-applicable faction, exiting")
		return nil 
	end
	
	-- call upon the forces of CCO to get active faction initiative data
	local active_inits = {}
	local num_initiative_sets = common.get_context_value("CcoCampaignFaction",faction_key,"InitiativeSetList.Size")  -- defining this here just in case something changes in the future that would cause the initiative set list for a faction to differ from what we assume in our info table above
	
	for init_set, techs_per_set in pairs(faction_entry.techs) do
	
		for i = 0, (num_initiative_sets - 1) do
			local set_to_check = common.get_context_value("CcoCampaignFaction",faction_key,("InitiativeSetList[" .. tostring(i) .. "].InitiativeSetContext.Key"))

			if set_to_check == init_set then
				active_inits[init_set] = common.get_context_value("CcoCampaignFaction",faction_key,("InitiativeSetList[" .. tostring(i) .. "].ActiveInitiatives.Size"))
				ModLog("DUX: valid initiative set " .. init_set .. " found with " .. tostring(active_inits[init_set]) .. " initiatives active")
				break 
			end
		end
		
		for index, tech in ipairs(techs_per_set) do		
			-- check if we have this tech; proceed only if we do
			if not faction_obj:has_technology(tech) then
				ModLog("DUX: tech " .. tech .. " not unlocked for " .. faction_key .. " yet, skipping")
			else
				ModLog("DUX: Tech " .. tech .. " attained, proceeding with effects")

				local this_eb_key = faction_entry.effect_bundles[init_set][index]

				---@type CUSTOM_EFFECT_BUNDLE_SCRIPT_INTERFACE
				local custom_bundle
				
				if faction_obj:has_effect_bundle(this_eb_key) then
					for eb in model_pairs(faction_obj:effect_bundles()) do
						if eb:key() == this_eb_key then
							custom_bundle = eb:clone_and_create_custom_effect_bundle()
							break
						end
					end
				else
					custom_bundle = cm:create_new_custom_effect_bundle(this_eb_key)
				end

				-- -- create our custom effect bundle interface if it doesn't already exist
				-- if not cbfm_chs_init_tech_eb_table[faction_key][tech] then 
				-- 	ModLog("DUX: custom effect bundle not yet created for " .. faction_key .. ":" .. tech ..  ", creating now")
				-- 	cbfm_chs_init_tech_eb_table[faction_key][tech] = cm:create_new_custom_effect_bundle(faction_entry.effect_bundles[init_set][index])
				-- else
				-- 	ModLog("DUX: custom effect bundle already created for " .. faction_key .. ":" .. tech .. ", using existing bundle")
				-- end
				
				if active_inits[init_set] == 0 then ModLog("DUX: no active initatives were found, setting effect value for " .. faction_key .. ":" .. tech .. " to zero") end

				-- modify our effect bundle as required
				local num_effects = custom_bundle:effects():num_items()
				local base_value = 1 -- default

				for i = 0, (num_effects - 1) do
					local effect = custom_bundle:effects():item_at(i)
					local effect_key = effect:key()
					
					-- check if we have a custom base value saved for this effect. if not, default is 1
					if faction_entry.base_values[effect_key] then base_value = faction_entry.base_values[effect_key] end
					
					custom_bundle:set_effect_value(effect, (base_value * active_inits[init_set]))
					ModLog("DUX: effect " .. effect_key .. " being applied for " .. faction_key .. ":" .. tech .. " with base value: " .. tostring(base_value) .. " and multiplier: " .. tostring(active_inits[init_set]))
				end

				-- apply our effect bundle
				cm:apply_custom_effect_bundle_to_faction(custom_bundle, faction_obj)
			end
		end
	end
end

-- first_tick callbacks and turn_start listeners added for each applicable faction
for faction, _ in pairs(cbfm_chs_init_tech_faction_info_table) do
	cm:add_first_tick_callback(function() cbfm_chs_init_tech_update(faction,"game_load") end)
	cm:add_faction_turn_start_listener_by_name("cbfm_chs_init_tech_turn_start_listener",faction,function() cbfm_chs_init_tech_update(faction,"turn_start") end,true)
end

-- single FactionTurnEnd listener also added which checks to see if faction is in our table defined above before proceeding (implicit nil return otherwise). this is done to ensure authority effects properly update in time for the next turn
core:add_listener(
	"cbfm_chs_init_tech_turn_end_listener",
	"FactionTurnEnd",
	function(context) return cbfm_chs_init_tech_faction_info_table[context:faction():name()] ~= nil end,
	function(context) cbfm_chs_init_tech_update(context:faction():name(),"turn_end") end,
	true
)